# HTTP链接管理

[TOC]

## 短连接

HTTP/0.9/1.0，通信过程采用了简单的“**请求-应答**”方式

**缺点:**

建立连接和关闭连接都是非常**昂贵**的操作

- 需要三次握手（三个数据包，一个RTT）
- 四次挥手（需要四个数据包，2个RTT）

## 长连接

HTTP/1.1，提出了“**长连接**”的通信方式

“**成本均摊**”的思路，既然TCP的连接和关闭非常耗时，那么就把这个时间成本由原来的一个“**请求-应答**”均摊到多个“**请求-应答**”上。

![](I:\myFuture\桌面资料\面试\学习图片\短连接VS长连接.png)

## 连接相关的头字段

- 服务端：“**Connection：keep-alive**”

**缺点：**

因为TCP连接长时间不关闭，服务器必须再内部保存它的状态，这就占用了服务器的资源，如果有大量的空闲长连接只连不发，就会很快耗尽服务器的资源，倒是服务器无法为真正有需要的用户提供服务

所以，长连接也需要在恰当的时间关闭，不能永远保持与服务器的连接

- 客户端：“**Connection：close**”字段，告诉服务器：“这次通信后就关闭连接”

服务器通常**不会主动关闭连接**

## 队头阻塞

“**队头阻塞**”与短连接和长连接无法，而是由HTTP基本的“请求-应答”模型所导致的。

因为HTTP规定报文必须是“**一发一收**”，这就形成了**先进先出的“串行”队列**。队列里请求没有轻重缓急的优先级，只有入队的先后顺序，排在最前面的请求被最优先处理。

如果：队首的请求因为处理的太慢耽误了时间，那么队列里后面的所有请求也不得不跟着一起等待，结果就是其他的请求承担了不应有的时间成本。

![](I:\myFuture\桌面资料\面试\学习图片\队头阻塞.png)

## 性能优化

因为“**请求-应答**”模型不能变，所以“队头阻塞”问题在HTTP/1.1无法解决

- 并发连接

既然串行队列可能会因为队头进行阻塞，那么我们可以使用“**并发连接**”，同时对**一个域名发起多个长连接，用数量来解决质量问题。**

**缺点：**用户为了追求速度，不断地增加连接，这样服务器地资源根本就扛不住，或者服务器认为是恶意攻击，反而会造成“**拒绝服务**”

协议规定每个用户最多并发6-8个连接

- 域名分片

还是使用数量来解决质量的思路

`www.a.domain.com` 和 `www.b.domain.com` 都指向`www.domain.com`