# HTTP/2内核剖析

[TOC]

## 头部压缩

报文还是“Header+Body”构成的，但是在请求发送前，必须要用“**HPACK**”算法来压缩头部数据。

“**HPACK**”专门为压缩HTTP头部指定的算法，需要客户端和服务端各自维护一份“**索引表**”，也可以说是“**字典**”，压缩和解压缩就是查表和更新表的操作。

![](I:\myFuture\桌面资料\面试\学习图片\HPACK索引表.png)

“**Header Name**”是“**伪头字段**”。与真头字段区分开来，在前面加了个“**：**”

将一些常用的字段定义了一个只读的“**静态表**”

但是如果表里只有Key没有value，或者是自定义的字段根本找不到呢？

这里就需要用到“**动态表**”，添加到静态表后面，结构相同，但会在编码解码的时候随时更新

例如：第一次发送“user-agent”字段长100多个字节，用哈夫曼压缩编码发送之后，客户端和服务端都更新自己的动态表，添加一个新的索引号。那么下一次发送的时候就不用再重复发那么多自己了，只要用一个字节发送编号就好了。

## 二进制帧

头部数据压缩之后，HTTP/2就要把报文拆成二进制的帧准备发送

HTTP/2的帧结构优点类似TCP的段或者TLS里的记录，头部只有9字节

![](I:\myFuture\桌面资料\面试\学习图片\HTTP2二进制帧.png)

- 帧长度：默认上限时2^14，最大是2^24，HTTP/2的帧通常不超过16K，总共的最大是16M
- 帧类型：数据帧和控制帧
  - 数据帧：HEADERS帧和DATA帧
  - SETTINGS、PING、PRIORITY等又来管理流的控制帧
- 帧标志：携带简单的控制信息
- 流标识符：接收方使用它就可以从乱序的**帧**里识别出**具有相同流ID的帧**序列，按顺序**组装**起来实现了虚拟的“流”

## 流与多路复用

**流时二进制帧的双向传输序列**

在HTTP/2连接上，虽然帧时乱序收发的，但是只要他们拥有相同的流ID，就都术语一个流，而且在这个流里帧不是无序的，而是有者严格的先后顺序。

HTTP/2的流特点：

- 流时可并发的
- 客户端和服务端都可以创建流，双方互不干扰
- 流是双向的
- 流之间没有固定关系，彼此独立
- 流可以设置优先级，让服务器优先处理
- 流ID不能重复，只能顺序递增，客户端发起的ID是奇数，服务端发起的ID是偶数
- 在流上发送“RST_STREAM”帧可以随时终止流，取消接收或发送
- 第0号流比较特殊，不能关闭，也不能发送数据帧，只能发送控制帧，用于流量控制

![](I:\myFuture\桌面资料\面试\学习图片\二进制流2.png)

HTTP/2默认就是长连接的，所以永远不需要“**Connection**”头字段

