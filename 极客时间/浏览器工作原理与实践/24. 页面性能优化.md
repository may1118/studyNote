# 页面性能优化

[TOC]

页面优化目的：“**让页面更快的响应和显示**”

通常一个页面的三个阶段：

- 加载阶段：发出请求到渲染出完整页面的过程
- 交互阶段：页面加载完成到用户交互和整合过程
- 关闭阶段：用户发出关闭指令后页面所做的一些清理工作

暂时，主要关注：加载阶段和交互阶段

## 加载阶段

![](I:\myFuture\桌面资料\面试\学习图片\加载阶段渲染流水线.png)

前面的学习知道：并非所有的资源都会阻塞页面的首次绘制，比如：图片、音频、视频等文件就不会阻塞页面的首次渲染；而JavaScript、首次请求的HTML资源文件、CSS文件是会阻塞首次渲染的，因为在构建DOM的过程中需要HTML和JavaScript文件，在构造渲染树的过程中需要用到CSS文件

“**我们把能阻塞网页首次渲染的资源称为关键资源**”，可以细化出页面渲染的核心因素

- 关键资源的个数
- 关键资源的大小
- 请求关键资源需要多少个RTT
  - 使用TCP协议传输一个文件时，由于TCP的特性，数据并不是一次传输到服务端的，而是需要查分成一个个数据包来回多次传输的。RTT就是这的往返实验。是网络中重要的性能指标，表示从发送端发送数据开始，到接收端收到来自接收端的确认，总共经历的时延。

**总结的优化原则**：减少关键资源的个数，降低关键资源的大小，降低关键资源的RTT次数

### 减少关键资源个数

1. 可以将JavaScript和CSS改为内联的形式
2. 如果JavaScript代码没有DOM或者CSSOM操作，则可以改成async或者defer属性
3. CSS如果不再构建页面之前加载，则可以添加媒体取消阻止显示的标志

2和3是将一些资源变成非关键资源

### 减少关键资源大小

可以压缩CSS和JavaScript资源，移除HTML、CSS和JavaScript文件中的一些注释内容，也可以通过前面说的取消CSS或者JavaScript中关键资源的方式

### 减少RTT次数

减少关键资源的和数和减少关键资源的大小搭配实现，还可以使用CDN来减少每次RTT时长。

## 交互阶段

其实主要关注点就是：渲染进程渲染帧的速度，因为在交互阶段，帧的渲染速度决定了交互的流畅度。

![](I:\myFuture\桌面资料\面试\学习图片\交互阶段渲染流水线.png)

大部分情况下：生成一个新的帧都是由JavaScript通过修改DOM或者CSSOM触发的，还有一部分帧是由CSS来触发的

- JavaScript：重排、重绘
- CSS：合成

大的原色就是让单个帧的生成速度变快

### 减少JavaScript脚本执行时间

JavaScript函数一次执行可能需要几百毫秒，这就严重**霸占了主线程**执行其他渲染任务的时间，优化策略：

- 将一次执行的函数分解为多个任务，使得每次的执行时间不要过久
- 采用web workers，当作主线程之外的一个线程执行，只是不能访问DOM和CSSOM环境

”**总结：**“不要一次霸占太久主线程

### 避免强制同步布局

强制同步布局：JavaScript强制将计算样式和布局操作提前到当前任务中

可以：在修改DOM之前查询相关值

### 避免布局抖动

布局抖动：在一次JavaScript执行过程中，多次执行强制布局和抖动操作（多次修改布局内容）

尽量不要在修改DOM结构时再去查询一些相关值，或者一次修改完成，避免多次调用DOM

### 合理利用CSS合成动画

因为合成动画是直接在合成线程上执行的，这和主线程上执行的布局、绘制等操作不同，如果被JavaScript或者一些布局任务占用，CSS动画依然能继续执行。所以要尽量使用好CSS合成动画，如果能让CSS处理动画，尽量交给CSS来操作

如果提前知道某个元素执行动画操作，那么最好标记为`will-change`，告诉渲染引擎需要将该元素单独生成一个图层

### 避免频繁的垃圾回收

JavaScript使用了自动垃圾回收机制，如果在函数中频繁创建临时对象，那么垃圾回收器也会频繁去执行回收策略。

垃圾回收操作发生时，会占用主线程，从而引响到其他任务的执行，严重的话还会让用户产生掉帧、不流畅的感觉

所以：尽量避免呈上那些临时垃圾数据，可以尽可能优化存储结构，尽可能避免小颗粒对象的产生