# 安全沙箱

[TOC]

现代浏览器采用了多进程架构，将渲染进程和浏览器主进程做了分离

![](I:\myFuture\桌面资料\面试\学习图片\浏览器内核和渲染进程.png)

浏览器主要被划分为：**浏览器内核**和**渲染内核**两个核心模块

- 浏览器内核：网络进程、浏览器主进程和GPU进程
- 渲染内核：渲染进程

因为所有的资源都是浏览器内核来下载的，下载后的资源会通过IPC提交给渲染进程（IPC：让浏览器内核和渲染进程通信）。然后渲染进程会对这些资源进行解析、绘制等操作，最终生成一幅图片。

但是渲染进程并不负责将图片显示到界面上，而是最终生成的图片交给浏览器内核模块，由浏览器内核负责显示这张图片。

“**疑问：**”

- 为什么一定要通过浏览器内核去请求资源，再将数据转发给渲染进程，而不直接从进程内部去请求网络资源？
- 为什么渲染进程只负责生成页面图片，生成图片还要经过IPC通知浏览器内核模块，然后让浏览器内核去负责展示图片？

解释：总的来说是为了保证安全

## 安全沙箱

由于渲染进程需要执行解析DOM、解析CSS、网络图片编码等操作，如果渲染进程中存在系统级别的扣动，那么以上操作都可能让恶意站点获取到渲染进程的控制权限，进而又获得操作系统的权限，这个对于用户是非常危险的。

因为网络资源的内容存在各种个能性，所以浏览器会默认所有的网络资源都是不可信的，都是不安全的。但谁也不能保证浏览器不存在漏洞，只要出现漏洞，黑客就可以通过网络内容对用户发起攻击。

浏览器可以安全下载各种网络资源，但是如果要执行这些资源，比如解析HTML、解析CSS、执行JavaScript，图片编码等操作，就需要非常谨慎了，因为一不小心，黑客就会利用这些操作对含有漏洞的浏览器发起攻击

基于以上原因，**我们需要再渲染进程和操作系统间建一道墙，即时渲染进程由于存在漏洞被黑客攻击，但是由于这道墙，黑客就获取不到渲染进程之外的任何操作权限**。**将渲染进程和操作系统隔离的这道墙就是我们说的安全沙箱。**

浏览器中的安全沙箱是利用操作系统的安全技术，**让渲染进程在执行过程中无法访问或者修改操作系统中的数据**，**在渲染进程需要访问系统资源的时候，需要通过浏览器内核来实现，然后将访问的结果通过IPC转发给渲染进程**。

安全沙箱最小的保护单位是进程。因为单进程浏览器需要频繁访问或者修改操作系统的数据，所以单线程浏览器是无法被安全沙箱保护的，而现代浏览器采用的多进程架构使得安全沙箱可以发挥作用。

## 安全沙箱如何影响各个模块

安全沙箱最小的保护单位是进程，并且能限制进程对操作系统资源的访问和修改，这就意味着如果要让安全沙箱应用在某个进程上，那么这个进程必须没有读写操作系统的功能，比如读写本地文件、发起网络请求、调用GPU接口等。

![](I:\myFuture\桌面资料\面试\学习图片\浏览器内核和渲染进程各自职责.png)

安全沙箱如何影响各个模块功能的？

### 持久存储

由于安全沙箱负责确保渲染进程无法直接访问用户的文件系统，但是在渲染进程内部有访问Cookie的需求、有上传文件的需求，为了解决这些文件的访问需求，现代浏览器将读写文件的操作都放在了浏览器内核中实现，然后通过IPC将操作结果转发给渲染进程

在浏览器内核中完成的：

- 存储Cookie数据的读写
- 缓存文件的读写

### 网络访问

渲染进程不能直接访问网络，如果要访问网络，则需要通过浏览器内核。不过浏览器内核在处理URL请求之前，会检查渲染进程是否有权限请求该URL，比如检查XMLHttpRequest或者Fetch是否是跨站点请求，或者检测HTTPS的站点中是否包含了HTTP请求

### 用户交互

*通常情况下，如果你要实现⼀个UI程序，操作系统会提供⼀个界⾯给你，该界⾯允许应⽤程序与⽤⼾交互， 允许应⽤程序在该界⾯上进⾏绘制，⽐如Windows提供的是HWND，Linux提供的XWindow，我们就把 HWND和XWindow统称为窗⼝句柄。应⽤程序可以在窗⼝句柄上进⾏绘制和接收键盘⿏标消息。*

渲染进程内部是无法直接操作窗口句柄的，也就限制了渲染进程监控到用户的输入事件。

因此渲染进程需要做出两大改变

- 渲染进程需要渲染出位图。为了向用户显示渲染进程渲染出的位图，渲染进程需要将生成好的位图发送给浏览器内核，然后浏览器内核上将位图复制到屏幕上
- 操作系统没有将用户输入事件直接传给渲染进程，而是将这些事件传给浏览器内核。然后浏览器内核再根据当前浏览器界面的状态来判断如何调度这些事件，如果当前焦点位于浏览器地址栏中，则输入事件会在浏览器内核内部处理；如果当前焦点在页面的区域内，则浏览器内核会将输入事件转发给渲染进程

这样可以监控到用户输入事件的能力，所以所有的键盘鼠标事件都是由浏览器内核来接收的，然后浏览器内核再通过IPC将这些事件发送给渲染进程

### 站点隔离

Chrome将同一站点中相互关联的页面放在同一个渲染进程中执行。

目前所有操作系统都面领着两个A级漏洞——幽灵和熔毁，这两个漏洞是否处理器架构导致的，很难修补，黑客通过这两个漏洞可以直接入侵到进程的内部，如果入侵的进程没有安全沙箱的保护，那么黑客还可以发起对操作系统的攻击。

（如果没有沙箱保护，解析DOM、解析CSS、执行JavaScript.....——> 直接到浏览器内部攻击）

实现了站点隔离，就可以将恶意的iframe隔离再恶意程序的内部，使得它无法继续访问其他iframe进程内部，因此也就无法攻击其他站点了。