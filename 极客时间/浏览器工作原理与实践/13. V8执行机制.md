# V8执行机制

[TOC]

## 编译器和解释器

编译型语言：在程序执行之前，需要经过**编译器**的编译过程，并且编译之后会直接保存及其能读懂的二进制文件，这样每次运行程序时，都可以直接运行二进制文件，而不需要重新编译了。例如：C/C++、GO等

解释型语言：每次运行时都需要通过**解释器**对程序进行动态解释和执行。例如：python、JavaScript等

![](I:\myFuture\桌面资料\面试\学习图片\编译器和解释器.png)

## V8如何执行一段JavaScript代码

![](I:\myFuture\桌面资料\面试\学习图片\V8执行一段代码流程.png)

可以清楚的看到有**解释器**（Ignition）和**编译器**（TurboFan）

### 1. 生成抽象语法树（AST）和执行上下文

高级语言时开发者可以理解的语言，但是让编译器或者解释器来理解就非常困难了。对于编译器或者解释器来说，它们可以理解的就是AST了。所以无论用什么语言，在编译过程中，都会生成一个AST。

AST的结构和代码结构非常相似，其实也可以把AST堪称代码的结构化的标识，编译器或者解释器后续的工作都需要依赖于AST，而不是源代码。

#### 词法分析

将一行行的源码拆解成一个个token

”**token**“：语法上不可能再分的、最小的单个字符或字符串。

#### 语法分析

将token，根据语法规则转为AST。如果源码符合语法规则，这一步会顺利完成。但如果源码存在语法错误，这一步就会终止，并抛出一个”**语法错误**“。

### 2. 生成字节码

解释器Ignition，会根据AST生成字节码，并解释执行字节码。

字节码就是介于AST和机器码之间的一种代码。但是于特定类型的机器码无关，字节码需要通过解释器将其转换为机器码后才能执行。

（因为由AST直接转换为机器码，效率比较低，内存消耗大）

### 3. 执行代码

在执行字节码的过程中，如果发现了热点代码（一段代码被重复执行多次），TurboFan就会把这段**热点的字节码编译为高效的机器码**，然后当再次执行这段被优化的代码时，**只需要执行编译后的机器码就可以了**，这样大大提升了代码的执行效率。

#### 即时编译（JIT）

就是：编译器Ignition在解释执行字节码的同时，收集代码信息，当它发现某一部分代码变热了之后，TurboFan编译器便闪亮登场，把热点的字节码转换为机器码，并把转换后的机器码保存起来，以便下次使用