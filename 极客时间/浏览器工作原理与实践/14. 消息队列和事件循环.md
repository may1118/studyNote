# 消息队列和事件循环

[TOC]

## 第一版

如果所有的任务都已经确认好了，那么可以按照顺序执行即可，等所有的任务执行完成之后，线程会自动退出。

## 第二版

但是并不是所有的任务都是执行之前统一安排好的，但部分情况下，新任务都是线程运行过程中产生的

所以，要想在线程运行过程中，能接收并执行新的任务，就需要采用**事件循环机制**。

”**改进：**“

- 引入循环机制
- 引入事件

## 第三版

**处理其他进程发送过来的任务**

![](I:\myFuture\桌面资料\面试\学习图片\渲染进行线程之间发送任务.png)

使用**消息队列**接收其他进程发送的任务

消息队列是一种数据结构，可以存放要执行的任务。符合”**先进先出**“的特点，也就是说需要添加任务的话，添加到队列的尾部，取出任务的话，从队列头部取出。

![](I:\myFuture\桌面资料\面试\学习图片\队列+循环.png)

可以看出整个过程分为三步：

- 添加一个消息队列
- IO线程中产生新任务添加到消息队列尾部
- 渲染主进程会循环地从消息队列头部中读取任务，执行任务

![](I:\myFuture\桌面资料\面试\学习图片\跨进程发送消息.png)

渲染进行专门有一个IO线程用来接收其他进程传来地消息，接收到消息之后，会将这些消息组装成任务发送给渲染主线程

## 消息队列中任务类型

内部消息类型：输入事件（鼠标滚动、点击、移动）、微任务、文件读写、WebSocket、JavaScript定时器等等

页面相关事件：JavaScript执行、解析DOM、样式计算、布局计算、CSS动画等。

## 页面使用单进程的缺点

### 如何处理高优先级的任务

通常我们把消息队列中的任务称为宏任务，**每个宏任务中都包含了一个微任务队列**，在执行宏任务的过程中，如果DOM有变化，那么就会把该变化**添加到微任务队列中**，这样就不会影响到红任务的继续执行，因此也解决了效率问题。

**等宏任务中的主要功能都直接完成之后，这时候，渲染引擎并不着急去执行下一个宏任务，而是执行当前宏任务中的微任务。**

### 单个任务执行时长过久的问题

因为所有的任务都是单线程中执行的，所以每次只能执行一个任务，而其他任务都处于等待状态。如果其中一个任务执行时间过久，那么下一个任务就要等待很长时间。

**解决：**回调功能

