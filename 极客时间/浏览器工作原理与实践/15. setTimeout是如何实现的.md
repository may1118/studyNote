# setTimeout是如何实现的

[TOC]

setTimeout：是一个定时器，用来指定某个函数在多少毫秒之后执行。会返回一个整数，标识定时器的编号，可以用这个编号来取消定时器。

## 如何实现

### 事件循环系统

**典型的事件：**

- 当接收到HTML文档数据，渲染引擎就会将“**解析DOM**”事件添加到消息队列
- 当用户改变了Web页面的窗口大小，渲染引擎就会将“**重新布局**”的事件添加到消息队列
- 当触发了JavaScript引擎垃圾回收机制，渲染引擎会将“**垃圾回收**”任务添加到消息队列
- 如果要执行一段异步JavaScript代码，也是需要将“**执行任务**”添加到消息队列

但是定时器比较特殊，因为它需要在指定的时间间隔内被调用，但消息队列中的任务是按照**顺序执行**的，所以为了保证回调函数嗯那个在指定时间内执行，**不能将定时器的回调函数直接添加到消息队列中**。

### Chrome设计——延迟队列

除了正常使用的消息队列之外，还有另外一个消息队列，这个队列中维护了需要延迟执行的任务列表。所以当通过JavaScript创建一个定时器时，渲染进程会将该定时器的回调任务添加到**延迟队列中**

#### 创建

当通过JavaScript调用setTimeout设置回调函数的时候，渲染进程将会创建一个回调任务，包含了**回调函数**、**当前发起的时间**、**延迟执行时间**。

#### 触发

“**ProcessDellayTask**”（源码中的函数名称）函数会根据发起时间和延迟时间计算出到期的任务，然后依次执行这些到期的任务，等到期的任务执行完成之后，再继续下一个循环过程。

设置一个定时器，JavaScript引擎会返回一个定时器ID，通常情况下，当一个定时器的任务还没有被执行的时候，也是可以取消的，具体方法是调用“**clearTimeout**”函数，并纯如需要取消的定时器ID。

## 注意事项

### 1. 当前任务执行时间过久，会影响延迟到期的定时器任务执行

### 2. 如果setTimeout存在嵌套调用，那么系统设置最短时间间隔为4毫秒

### 3. 未激活的页面，setTimeout执行最小间隔是1000毫秒

如果标签不是当前的激活标签，那么定时器最小的时间间隔是1000毫秒，目的是为了优化后台页面的加载损耗以及降低耗电量。

#### 4. 延迟执行时间有最大值

Chrome、Safari、Firefox都是以32bit来存储延时值的，最大时2147483647毫秒（大约是24.8天）时会溢出，这将导致定时器会被立即执行。

### 使用setTimeout设置回调函数中的this不符合直觉

如果背setTimeout推迟执行的回调函数时某个对象的方法，那么该方法中的this关键字将指向全局环境，而不是定义时的那个对象。