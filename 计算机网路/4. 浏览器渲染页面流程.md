# 浏览器渲染页面流程

[学习博客](https://juejin.im/post/5a8e242c5188257a6b060000)

浏览器从服务器获取到html文档后，需要呈现出来，会经过

## 解析文档构建DOM树

浏览器接收到HTML之后，会遍历文档节点，生成DOM树

DOM树的生成过程可能会被CSS和JS的加载执行阻塞

## 构建CSSOM树

浏览器解析CSS文件生成CSS规则树，每个CSS文件都会分析成一个StyleSheet对象，每个对象包含CSS规则。CSS规则对象包含对应于CSS语法的选择器和生命对象及其他对象。

## 渲染阻塞

当浏览器遇到一个script标签时，DOM构建将暂停，直至脚本完成执行，然后继续构建DOM。

如果再执行JavaScript脚本还操作了CSSOM，而正好这个CSSDOM还没有下载和构建，浏览器甚至会延迟脚本执行和DOM构建，直至完成CSSOM的下载和构建

所以，script标签的位置很重要，一般遵循的规则是：

- CSS优先
- JS滞后

当解析html时，会把新来的元素插入DOM树中，同事去查找CSS，然后把对应的规则应用到元素上，查找样式表按照从右到左的顺序去匹配，所以平常写样式的时候，尽量减少查找层数，使用id和class

## 构建渲染树

通过DOM树和CSS规则树我们可以构建渲染树。浏览器会从DOM树的根节点开始遍历每个可见节点。找到适配的CSS样式规则并应用。

构建完成之后，每个检点都是**可见节点**并且都含有其内容对应的规则样式。

## 布局和绘制渲染树

**布局**：从根节点开始遍历，然后确定每个节点对象在页面上的确切大小和位置，生成一个个的盒字模型，精确的捕获每个元素在屏幕内的确切位置与大小。

**绘制**：调用渲染器的paint()方法在屏幕上显示其内容。渲染书的绘制工作是由浏览器的UI后端组件完成的。

### 重绘与回流

**重绘**：屏幕的一部分重画，不会影响整体布局

**回流**：原件的几何尺寸变了，需要重新验证并计算渲染树

### 减少重绘和回流

- 如果需要频繁的使用JavaScript操作DOM节点，可以使用documentFragment
- 使用translate代替top
- 使用opacity代替visiability
- 访问DOM偏移量属性时进行缓存(scrollTop\offsetTop...)
- 频繁改变某一节点，可以先：display:none
- 少使用table布局
- 需要频繁回流重绘的，单独抽出一个图层
  - transition:translateZ(0)
  - will-change:transform

