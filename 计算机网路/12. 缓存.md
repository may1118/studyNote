# 缓存

值得的多读几次[学习链接](https://juejin.im/post/5a6c87c46fb9a01ca560b4d7)

## 缓存优点

- 减少服务器的压力
- 提升性能
- 减少带宽消耗

## 浏览器缓存

- 缓存目标：GET请求

- **浏览器对于缓存的处理是根据第一次请求资源时返回的响应头来确定的**

- 缓存分类

  - 浏览器会发送一个请求，带有有关的字段，如果响应头说，你可以从自己的缓存中取，就返回200/304，那么浏览器就会从缓存中取，并且没有实体内容跟，如果内容进行了修改，就会返回200，并且有新的资源

  - 强缓存（200）

    - `chache-control`（通用字段）(http1.1 优先级高)
    - `Expires`（响应）(http1.0)
    - 但是200（from disk cache） 200（from memory cache），这个是根据命中率来决定的，如果命中率高，经常使用，就放到磁盘中，如果命中率低就放到内存中

  - 协商缓存（304）

    - `Etag`（响应） / `If-None-Match`（请求）

      - **请求指令**

      - | 指令            | 参数               | 说明                              |
        | --------------- | ------------------ | --------------------------------- |
        | no-cache        | 无                 | 强制源服务器再次验证              |
        | no-store        | 无                 | 不缓存请求或是响应的任何内容      |
        | max-age=[秒]    | 缓存时长，单位是秒 | 缓存的时长，也是响应的最大的Age值 |
        | min-fresh=[秒]  | 必需               | 期望在指定时间内响应仍然有效      |
        | no-transform    | 无                 | 代理不可更改媒体类型              |
        | only-if-cached  | 无                 | 从缓存获取                        |
        | cache-extension | -                  | 新的指令标记(token)               |

      - 响应指令

      - | 指令             | 参数               | 说明                                           |
        | ---------------- | ------------------ | ---------------------------------------------- |
        | public           | 无                 | 任意一方都能缓存该资源(客户端、代理服务器等)   |
        | private          | 可省略             | 只能特定用户缓存该资源                         |
        | no-cache         | 可省略             | 缓存前必须先确认其有效性                       |
        | no-store         | 无                 | 不缓存请求或响应的任何内容                     |
        | no-transform     | 无                 | 代理不可更改媒体类型                           |
        | must-revalidate  | 无                 | 可缓存但必须再向源服务器进确认                 |
        | proxy-revalidate | 无                 | 要求中间缓存服务器对缓存的响应有效性再进行确认 |
        | max-age=[秒]     | 缓存时长，单位是秒 | 缓存的时长，也是响应的最大的Age值              |
        | s-maxage=[秒]    | 必需               | 公共缓存服务器响应的最大Age值                  |
        | cache-extension  | -                  | 新指令标记(token）                             |

    - `Last-Modified`（响应） / `If-Modified-Since`（请求）

## HTML5缓存

**离线缓存**，manifest

`Service Worker`

## 代理服务器缓存

保存一些经常访问的页面和对象

## 网关缓存

## 数据库缓存

## CDN分发网络

## 关于缓存的一些问答

**1. 问题：请求被缓存，导致新代码未生效**

> **解决方案:**

- 服务端响应添加`Cache-Control:no-cache,must-revalidate`指令；
- 修改请求头`If-modified-since:0`或`If-none-match`；
- 修改请求URL，请求URL后加随机数，随机数可以是时间戳，哈希值，比如：[damonare.cn?a=1234](http://damonare.cn?a=1234)

**2. 问题：服务端缓存导致本地代码未更新**

> **解决方案：**

- 合理设置Cache-Control:s-maxage指令；
- 设置Cache-Control:private指令，防止代理服务器缓存资源；
- CDN缓存可以使用管理员设置的缓存刷新接口进行刷新；

**3. 问题： Cache-Control: max-age=0 和 no-cache有什么不同**

> **回答：**

`max-age=0`和`no-cache`应该是从语气上不同。`max-age=0`是告诉客户端资源的缓存到期**应该**向服务器验证缓存的有效性。而`no-cache`则告诉客户端使用缓存前**必须**向服务器验证缓存的有效性。