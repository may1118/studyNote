# SSL/TSL协议运行机制

[TOC]

## 作用

不使用SSL/TSL的HTTP通信，就是不加密的通信。所有信息明文传播，带来了三大风险。

- 窃听风险：第三方可以通知通信内容
- 篡改风险：第三方可以修改通信内容
- 冒充风险：第三方可以冒充他人身份参与通信

SSL/TLS协议是为了解决这三大风险而设计的，希望达到

- 所有信息都是**加密传播**，第三方无法窃听
- 具有校验机制，一旦被篡改，通信双方会立刻发现
- 具备身份证书，防止身份被冒充

## 过程

SSL/TLS协议的基本思路是采用**公钥加密法**，也就是说，客户端先向服务器端索要公钥，然后用公钥加密信息，服务器收到密文后，用自己的私钥解密。

### 1. 如何保证公钥不被篡改

将公钥放在数字证书中。只要证书是可信的，公钥就是可信的。

### 2. 公钥加密计算量太大，如何减少耗用的时间？

每一次对话，客户端和服务器端都生成一个**对话密钥**，用它来加密信息。由于对话密钥是对称加密的，所以运行速度非常快，而服务器公钥只用于加密对话密钥本身，这样就减少了运算的消耗时间。

因此，SSL/TLS协议的基本过程是：

1. 客户端向服务器端幺幺并验证公钥
2. 双方协议生成“**对话密钥**”
3. 双方采用对话密钥进行加密通信

上面过程的前两部，又成为“**握手阶段**”

## 握手阶段的详细过程

![](I:\myFuture\桌面资料\面试\学习图片\握手阶段.png)

### 客户端发出请求（ClientHello）

> （1） 支持的协议版本，比如TLS 1.0版。
>
> （2） 一个客户端生成的随机数，稍后用于生成"对话密钥"。
>
> （3） 支持的加密方法，比如RSA公钥加密。
>
> （4） 支持的压缩方法。

### 服务器回应（ServerHello）

> （1） 确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。
>
> （2） 一个服务器生成的随机数，稍后用于生成"对话密钥"。
>
> （3） 确认使用的加密方法，比如RSA公钥加密。
>
> （4） 服务器证书。

### 客户端回应

客户端收到服务器回应以后，首先验证服务器证书。如果证书不是可信机构颁布、或者证书中的域名与实际域名不一致、或者证书已经过期，就会向访问者显示一个警告，由其选择是否还要继续通信。

> （1） 一个随机数。该随机数用服务器公钥加密，防止被窃听。
>
> （2） 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
>
> （3） 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供服务器校验。

### 服务器的最后回应

> （1）编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
>
> （2）服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供客户端校验。

## 最后

整个握手阶段全部结束，接下来，客户端与服务器进入加密通信，就完全使用普通的HTTP协议，只不过用“**会话密钥**”加密内容。